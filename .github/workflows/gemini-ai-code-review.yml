name: Gemini AI Code Review # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ ì •ì˜

on: # ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì •ì˜
  workflow_dispatch: # GitHub ì›¹ UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥
  pull_request: # PRì´ ì—´ë¦¬ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
    types: [ opened, synchronize ]

jobs:
  code-review: # ì‘ì—… ì´ë¦„ ì •ì˜
    runs-on: ubuntu-latest # ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ ì§€ì •
    permissions: # í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
      contents: read # ì €ì¥ì†Œ ë‚´ìš© ì½ê¸° ê¶Œí•œ
      pull-requests: write # PR ëŒ“ê¸€ ì‘ì„± ê¶Œí•œ
    steps:
      - name: Checkout repository # ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ ë‹¨ê³„
        uses: actions/checkout@v3 # GitHub ì œê³µ ì•¡ì…˜ ì‚¬ìš©
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diff ê³„ì‚°ì„ ìœ„í•´ í•„ìš”)

      - name: Set up Node # Node.js í™˜ê²½ ì„¤ì • ë‹¨ê³„
        uses: actions/setup-node@v3 # Node.js ì„¤ì¹˜ ì•¡ì…˜

      - name: Install GoogleGenerativeAI # Gemini API ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë‹¨ê³„
        run: |
          npm install @google/generative-ai # Gemini API í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜

      - name: Get git diff # ì½”ë“œ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ ë‹¨ê³„
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRì¸ ê²½ìš° baseì™€ head ë¸Œëœì¹˜ ê°„ì˜ diff ê³„ì‚°
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            git fetch origin "$BASE_REF"
            git fetch origin "$HEAD_REF"
            git diff --unified=0 "origin/$BASE_REF" > "diff.txt"
          else
            # ì§ì ‘ ì‹¤í–‰í•œ ê²½ìš° í˜„ì¬ ì»¤ë°‹ê³¼ ì´ì „ ì»¤ë°‹ ê°„ì˜ diff ê³„ì‚°
            git diff --unified=0 HEAD^ > "diff.txt"
          fi

      - name: Run Gemini-1.5-flash # Gemini AIë¡œ ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰ ë‹¨ê³„
        uses: actions/github-script@v7 # JavaScript ì‹¤í–‰ ì•¡ì…˜
        with:
          script: |
            const fs = require("fs");
            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI("${{ secrets.GEMINI_API_KEY }}");
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const diff_output = fs.readFileSync("diff.txt", "utf8");
            
            // í•œêµ­ì–´ë¡œ ì½”ë“œ ë¦¬ë·° ìš”ì²­ ë° íŠ¹ì • JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ ìš”ì²­
            const prompt = `Explain in korean. You are a senior software engineer and need to perform a code review based on the results of a given git diff. Review the changed code from different perspectives and let us know if there are any changes that need to be made. If you see any code that needs to be fixed in the result of the git diff, you need to calculate the exact line number by referring to the "@@ -0,0 +0,0 @@" part. The output format is [{"path":"{ filepath }", "line": { line }, "text": { review comment }, "side": "RIGHT"}] format must be respected. If the line number is not available or the code was entirely deleted, skip that file from the output. Only include comments for lines with valid, non-zero numbers that exist in the PR diff.


            <git diff>${diff_output}</git diff>`;
            
            async function run() {
              const result = await model.generateContent(prompt);
              const response = await result.response;
              const text = response.text();
              fs.writeFileSync("review_result.txt", text);
              console.log("Review results saved!");
            }
            
            return run();

      - name: Format PR review comments # ë¦¬ë·° ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë‹¨ê³„
        if: github.event_name == 'pull_request' # PRì¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        id: store # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì°¸ì¡°í•  ID
        run: |
          # Markdown ì½”ë“œ ë¸”ë¡ ì œê±° í›„ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          COMMENT=$(sed '/^```/d' review_result.txt | jq -c .)
          echo "comment=$COMMENT" >> $GITHUB_OUTPUT # ì¶œë ¥ ë³€ìˆ˜ì— ì €ì¥

      - name: Add Pull Request Review Comment # PRì— ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ ì¶”ê°€ ë‹¨ê³„
        if: github.event_name == 'pull_request' # PRì¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        uses: nbaztec/add-pr-review-comment@v1.0.7 # ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ ì¶”ê°€ ì•¡ì…˜
        with:
          comments: ${{ steps.store.outputs.comment }} # ì´ì „ ë‹¨ê³„ì˜ ì¶œë ¥ ì‚¬ìš©
          repo-token: ${{ secrets.GITHUB_TOKEN }} # GitHub í† í° ì‚¬ìš©
          repo-token-user-login: 'github-actions[bot]' # ì½”ë©˜íŠ¸ ì‘ì„±ì ì„¤ì •
          allow-repeats: false # ì¤‘ë³µ ì½”ë©˜íŠ¸ ë°©ì§€

      - name: Send Discord Notification # Discordì— ì•Œë¦¼ ì „ì†¡ ë‹¨ê³„
        if: github.event_name == 'pull_request' && success() # PRì´ê³  ì´ì „ ë‹¨ê³„ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        run: |
          # Discord ì›¹í›…ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"username": "Gemini Bot", "content": "ğŸ”” Gemini ì½”ë“œ ë¦¬ë·° ì™„ë£Œ! PRì—ì„œ í™•ì¸í•˜ì„¸ìš”: ${{ github.event.pull_request.html_url }}"}' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}